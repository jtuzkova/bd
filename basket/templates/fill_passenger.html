<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='booking.css') }}" rel="stylesheet" type="text/css">
</head>
<body>
  <div class="center-header-section">
    <h1 class="page-title">‚úàÔ∏è –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê</h1>

    <div class="header-buttons">
      <a href="{{ url_for('flight_bp.show_booking_page') }}" class="header-btn btn-secondary">
        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–∏—Å–∫—É
      </a>
    </div>
  </div>

  <div class="center-container">
    <div class="order-container">
      <div class="section-header">
        <h2 class="section-title">üìã –î–∞–Ω–Ω—ã–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤</h2>
        <p class="section-subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –ø–∞—Å—Å–∞–∂–∏—Ä–µ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤</p>
      </div>

      {% set total_tickets = basket.values() | sum(attribute='amount') %}

      <form action="{{ url_for('flight_bp.save_order') }}" method="POST" class="passenger-form">

        <!-- –§–æ—Ä–º—ã –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ -->
        <div class="passenger-forms-section">
          <h3 class="forms-title">üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞—Ö ({{ total_tickets }})</h3>

          <!-- –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–∏–ª–µ—Ç–æ–≤ -->
          {% set ticket_list = [] %}
          {% for key, item in basket.items() %}
            {% for i in range(item.amount) %}
              {% set _ = ticket_list.append({
                'departure': item.departure_airport,
                'arrival': item.arrival_airport,
                'date': item.date,
                'number': item.number,
                'class': item.class,
                'price': item.price,
                'key': key
              }) %}
            {% endfor %}
          {% endfor %}

          {% for ticket in ticket_list %}
            <div class="passenger-form-card">
              <div class="passenger-header">
                <h4 class="passenger-title">–ü–∞—Å—Å–∞–∂–∏—Ä {{ loop.index }}</h4>
                <span class="passenger-subtitle">–†–µ–π—Å {{ ticket.number }} ‚Ä¢ {{ ticket.class|title }}</span>
              </div>

              <!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–π—Å–µ -->
              <div class="ticket-info-compact">
                <div class="compact-route">
                  <div class="airport-box departure">
                    <span class="airport-code">{{ ticket.departure }}</span>
                  </div>
                  <div class="flight-line">
                    <div class="flight-dots"></div>
                    <div class="flight-plane">‚úàÔ∏è</div>
                    <div class="flight-dots"></div>
                  </div>
                  <div class="airport-box arrival">
                    <span class="airport-code">{{ ticket.arrival }}</span>
                  </div>
                </div>
                <div class="compact-details">
                  {% if ticket.date %}
                  <div class="detail-item">
                    <span class="detail-icon">üìÖ</span>
                    <span class="detail-text">{{ ticket.date }}</span>
                  </div>
                  {% endif %}
                  <div class="detail-item">
                    <span class="detail-icon">üí∞</span>
                    <span class="detail-text">{{ ticket.price }} —Ä—É–±.</span>
                  </div>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="passenger_name_{{ loop.index0 }}">–ò–º—è –§–∞–º–∏–ª–∏—è *</label>
                  <input type="text"
                         id="passenger_name_{{ loop.index0 }}"
                         name="passenger_name_{{ loop.index0 }}"
                         class="form-input"
                         placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
                         required />
                </div>

                <div class="form-group">
                  <label for="birthday_{{ loop.index0 }}">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è *</label>
                  <input type="date"
                         id="birthday_{{ loop.index0 }}"
                         name="birthday_{{ loop.index0 }}"
                         class="form-input"
                         required />
                </div>
              </div>

              <input type="hidden" name="ticket_key_{{ loop.index0 }}" value="{{ ticket.key }}">
            </div>
          {% endfor %}
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
        <div class="order-summary">
          <h3 class="summary-title">üì¶ –ò—Ç–æ–≥–∏ –∑–∞–∫–∞–∑–∞</h3>

          <div class="order-items">
            {% for key, item in basket.items() %}
            <div class="order-item">
              <div class="route-info">
                <strong>{{ item.departure_airport }} ‚Üí {{ item.arrival_airport }}</strong>
                <span class="flight-number">–†–µ–π—Å {{ item.number }}</span>
              </div>
              <div class="item-details">
                <span class="class-badge">{{ item.class|title }}</span>
                <span class="quantity">√ó{{ item.amount }}</span>
                <span class="price">{{ "%.2f"|format(item.price|float * item.amount) }} —Ä—É–±.</span>
              </div>
            </div>
            {% endfor %}
          </div>

          <div class="total-section">
            <div class="total-line">
              <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤:</span>
              <span>{{ total_tickets }}</span>
            </div>
            <div class="total-line main-total">
              <strong>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong>
              <strong class="total-amount">{{ "%.2f"|format(total_price) }} —Ä—É–±.</strong>
            </div>
          </div>
        </div>

        <input type="hidden" name="total_tickets" value="{{ total_tickets }}">

        <div class="form-actions">
          <button type="submit" class="btn-submit">
            ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑
          </button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>